services:
  app:
    profiles:
      - dev
    build:
      context: .
      dockerfile: docker/provisioning-dispatch/Dockerfile
    container_name: "provisioning-dispatcher-dev"
    restart: "on-failure"
    environment:
      LOG_LEVEL: "DEBUG"
    depends_on:
      - "nats"
    ports:
      - "7777:7777"

  nats:
    image: "nats:latest"
    environment:
      jetstream: "enabled"
    ports:
      - "4222:4222" # Client connections
      - "6222:6222" # Route connections
      - "8222:8222" # HTTP monitoring port
    command: --jetstream -m 8222 -p 4222

  dispatcher:
    build:
      context: .
      dockerfile: docker/dispatcher-service/Dockerfile
    container_name: "dispatcher-service"
    restart: "on-failure"
    environment:
      LOG_LEVEL: "DEBUG"
      NATS_HOST: "nats"
    depends_on:
      - "nats"

  #    # TODO: this is probably only useful temporarily, since the udm-listener also should be part of the Tilt stack,
  #  # but then maybe for integration testing ...
  #  udm-listener:
  #    # LDAP server and notifier need to be there
  #    image: gitregistry.knut.univention.de/univention/customers/dataport/upx/provisioning-api/udm-listener:${IMAGE_TAG:-latest}
  #    environment:
  #      # this config relies on running ldap server and notifier that have ports forwarded
  #      LDAP_HOST: "localhost"
  #      LDAP_BASE_DN: "dc=univention-organization,dc=intranet"
  #      LDAP_HOST_DN: "cn=admin,dc=univention-organization,dc=intranet"
  #      NOTIFIER_SERVER: "localhost"
  #      LDAP_PORT: "3089"
  #      DEBUG_LEVEL: "4"
  #      # Whether to start encryption and validate certificates.
  #      # Chose from "off", "unvalidated" and "secure".
  #      TLS_MODE: "off"
  #      LDAP_PASSWORD: "univention"
  #      LDAP_PASSWORD_FILE: "/var/secrets/ldap_secret"
  #    network_mode: "host"

  udm-listener:
    build:
      context: .
      dockerfile: docker/udm-listener/Dockerfile
    container_name: "udm-listener"
    environment:
      LDAP_HOST: "localhost"
      LDAP_BASE_DN: "dc=univention-organization,dc=intranet"
      LDAP_HOST_DN: "cn=admin,dc=univention-organization,dc=intranet"
      NOTIFIER_SERVER: "localhost"
      DEBUG_LEVEL: "4"
      TLS_MODE: "off"
      LDAP_PASSWORD: "univention"
      LDAP_PASSWORD_FILE: "/var/secrets/ldap_secret"
    network_mode: "host"

  ldap-notifier:
      platform: linux/amd64
      image: gitregistry.knut.univention.de/univention/customers/dataport/upx/container-ldap/ldap-notifier:latest
      build:
        context: ./docker/ldap-notifier
      depends_on:
        ldap-server:
          condition: service_started
      ports:
        - 6669:6669
      volumes:
        - ldap-shared-data:/var/lib/univention-ldap/:rw
        - ldap-shared-run:/var/run/slapd/:ro

  test:
    profiles:
      - test
    platform: "linux/amd64"
    environment:
      nats_host: nats
    image: gitregistry.knut.univention.de/univention/customers/dataport/upx/provisioning-api/provisioning-dispatch-test:${IMAGE_TAG:-latest}
    build:
      context: docker/provisioning-dispatch-test
    volumes:
      - type: bind
        source: .
        target: /app/

  # Environment of the pre-commit linter.
  pre-commit:
    profiles:
      - test
    image: gitregistry.knut.univention.de/univention/customers/dataport/upx/container-pre-commit/upx-pre-commit:latest
    volumes:
      - type: bind
        source: .
        target: /code
      - type: volume
        # pre-commit installs dependencies, having them cached speeds things up
        # a lot.
        source: pre-commit-cache
        target: /cache

  # Environment to build the documentation
  docs:
    image: docker-registry.knut.univention.de/sphinx:latest
    working_dir: /src/docs
    volumes:
      - ".:/src"
    profiles:
      - docs

  ldap-server:
    platform: linux/amd64
    image: gitregistry.knut.univention.de/univention/customers/dataport/upx/container-ldap/ldap-server:latest
    container_name: "ldap-server"
    environment:
      DOMAIN_NAME: univention-organization.intranet
      LDAP_BASE_DN: dc=univention-organization,dc=intranet
      LDAP_CN_ADMIN_PW: "univention"
      TLS_MODE: "off"
    ports:
      - 389:389
      - 636:636
    volumes:
      - ldap-shared-data:/var/lib/univention-ldap/:rw
      - ldap-shared-run:/var/run/slapd/:rw
#      - ./tests/base-defaults.conf:/etc/univention/base-defaults.conf:ro
      - type: bind
        source: ./tests/base.conf
        target: /etc/univention/base.conf
        read_only: true

  ldap-admin:
    image: osixia/phpldapadmin:0.9.0
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: "#PYTHON2BASH:[{'ldap-server':{'login':{'bind_id':'cn=admin,dc=univention-organization,dc=intranet'}}}]"
      PHPLDAPADMIN_HTTPS: "false"
    links:
      - ldap-server
    ports:
      - 8001:80

volumes:
  pre-commit-cache:
  ldap-shared-data:
  ldap-shared-run:


networks:
  openldap:
    driver: bridge